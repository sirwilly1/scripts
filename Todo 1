
int main(int argc, char **argv)
{
    int port = 9100;
    if (argc >= 2) port = atoi(argv[1]);
    int server = socket(AF_INET, SOCK_STREAM, 0);
    if (server < 0) { perror("socket"); return 1; }
    int opt = 1;
    setsockopt(server, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));
    struct sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(port);
    addr.sin_addr.s_addr = INADDR_ANY;
    if (bind(server, (struct sockaddr*)&addr, sizeof(addr)) < 0) { perror("bind"); return 1; }
    if (listen(server, 10) < 0) { perror("listen"); return 1; }
    printf("metrics_exporter: listening on 0.0.0.0:%d\n", port);

    while (1) {
        struct sockaddr_in cli;
        socklen_t clilen = sizeof(cli);
        int client = accept(server, (struct sockaddr*)&cli, &clilen);
        if (client < 0) continue;
        // naive, read small request
        char buf[2048];
        int r = recv(client, buf, sizeof(buf)-1, 0);
        if (r <= 0) { close(client); continue; }
        buf[r] = 0;
        // simple parse: look for GET /metrics
        if (strncmp(buf, "GET /metrics", 12) == 0) {
            handle_metrics_request(client);
        } else {
            send_404(client);
        }
        close(client);
    }
    close(server);
    return 0;
}
